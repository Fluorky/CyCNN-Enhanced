services:
  cycnn-gpu:
    build:
      context: .
      dockerfile: Dockerfile
    image: cycnn:gpu
    container_name: cycnn-gpu
    working_dir: /app/cycnn

    # Keep the container alive instead of exiting after one command
    command: ["bash", "-lc", "sleep infinity"]

    # Recommended settings for PyTorch + CUDA
    ipc: host
    ulimits:
      memlock: -1
      stack: 67108864

    volumes:
      - ./cycnn/logs:/app/cycnn/logs
      - ./cycnn/saves:/app/cycnn/saves
      - ./data:/app/cycnn/data

    # GPU support for Docker Compose v2
    gpus: all

    # Explicit NVIDIA runtime environment
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility

  cycnn-cpu:
    build:
      context: .
      dockerfile: Dockerfile.cpu
    image: cycnn:cpu
    container_name: cycnn-cpu
    working_dir: /app/cycnn

    # Keep CPU container alive as well
    command: ["bash", "-lc", "sleep infinity"]

    volumes:
      - ./cycnn/logs:/app/cycnn/logs
      - ./cycnn/saves:/app/cycnn/saves
      - ./data:/app/cycnn/data
